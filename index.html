<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerFit Gym - Inicio de Sesión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .bg-gym {
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://images.unsplash.com/photo-1571902943202-507ec2618e8f?ixlib=rb-4.0.3');
            background-size: cover;
            background-position: center;
        }
        .input-effect {
            transition: all 0.3s ease;
        }
        .input-effect:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="min-h-screen flex flex-col md:flex-row">
        <!-- Sección izquierda (imagen) -->
        <div class="w-full md:w-1/2 bg-gym flex items-center justify-center p-10 text-white">
            <div class="text-center max-w-md">
                <h1 class="text-4xl font-bold mb-4">GYM <span class="text-blue-500">PRO</span></h1>
                <p class="text-lg mb-6">Transforma tu cuerpo, fortalece tu mente</p>
                <div class="flex justify-center space-x-4">
                    <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                        <i class="fas fa-dumbbell text-2xl mb-2"></i>
                        <p>+50 Máquinas</p>
                    </div>
                    <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                        <i class="fas fa-users text-2xl mb-2"></i>
                        <p>+100 Miembros</p>
                    </div>
                    <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                        <i class="fas fa-trophy text-2xl mb-2"></i>
                        <p>Entrenadores Certificados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección derecha (formulario) -->
        <div class="w-full md:w-1/2 flex items-center justify-center p-8">
            <div class="w-full max-w-md bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-8">
                    <div class="flex justify-center mb-6">
                        <div class="bg-red-500 p-3 rounded-full">
                            <i class="fas fa-lock text-white text-2xl"></i>
                        </div>
                    </div>
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-1">Bienvenido</h2>
                    <p class="text-center text-gray-600 mb-8">Accede con tu cuenta de Google para continuar</p>

                    <!-- Botón de Google -->
                    <div class="mt-8">
                        <button id="googleLoginBtn"
                            class="btn-hover w-full flex items-center justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300">
                            <img class="w-5 h-5 mr-2" src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google logo">
                            Ingresar con Google
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { firebaseConfig } from './firebase-config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc, 
            query, 
            collection, 
            where,
            getDocs,
            writeBatch,
            setDoc,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Obtener elementos del DOM
        const googleLoginBtn = document.getElementById('googleLoginBtn');

        // Función para manejar el estado de carga de los botones
        const setLoading = (isLoading) => {
            if (isLoading) {
                googleLoginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Cargando...';
                googleLoginBtn.disabled = true;
            } else {
                googleLoginBtn.innerHTML = '<img class="w-5 h-5 mr-2" src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google logo"> Ingresar con Google';
                googleLoginBtn.disabled = false;
            }
        };

        // Función para mostrar errores
        const showError = (message) => {
            alert(message);
        };

        // Observador del estado de autenticación: redirige si el usuario ya está logueado
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuario autenticado, ahora verificamos su rol en Firestore
                setLoading(true); // Mostrar spinner mientras se verifica
                try {
                    let userData;
                    let userDoc;

                    // 1. Buscar por email primero, es el caso más común para migrar.
                    if (user.email) {
                        const userEmail = user.email.toLowerCase();
                        console.log(`Buscando usuario por email: ${userEmail}`);
                        const q = query(collection(db, "usuarios"), where("Email", "==", userEmail));
                        const querySnapshot = await getDocs(q);

                        if (!querySnapshot.empty) {
                            // 1a. Encontrado por email.
                            const foundDoc = querySnapshot.docs[0];
                            console.log(`Usuario encontrado por email con doc ID: ${foundDoc.id}.`);

                            // Si el ID del documento no es el UID de Auth, migrarlo.
                            if (foundDoc.id !== user.uid) {
                                console.log(`El ID del documento (${foundDoc.id}) no coincide con el UID de Auth (${user.uid}). Migrando...`);
                                const batch = writeBatch(db);
                                const oldData = foundDoc.data();
                                const newUserDocRef = doc(db, "usuarios", user.uid);

                                batch.set(newUserDocRef, { ...oldData, uid: user.uid, Email: userEmail });
                                batch.delete(foundDoc.ref);
                                await batch.commit();
                                
                                userDoc = await getDoc(newUserDocRef);
                                console.log("Migración completada.");
                            } else {
                                // El ID del documento ya es el UID de Auth, todo correcto.
                                userDoc = foundDoc;
                            }
                            userData = userDoc.data();
                        }
                    }

                    // 2. Si no se encontró por email, buscar por UID como fallback.
                    if (!userData) {
                        console.log("No se encontró por email, buscando por UID...");
                        const userDocRef = doc(db, "usuarios", user.uid);
                        userDoc = await getDoc(userDocRef);

                        if (userDoc.exists()) {
                            console.log(`Usuario encontrado por UID (${user.uid}).`);
                            userData = userDoc.data();
                        }
                    }

                    // 3. Si no se encontró por ningún método, es un usuario nuevo.
                    if (!userData) {
                        console.log("Usuario no encontrado. Creando nuevo registro de cliente.");
                        const userEmail = user.email.toLowerCase();
                        const userDocRef = doc(db, "usuarios", user.uid);
                        const fechaInicio = new Date();
                        const fechaFin = new Date();
                        fechaFin.setMonth(fechaFin.getMonth()); // Membresía de 1 mes por defecto

                        const newUser = {
                            uid: '',
                            Nombre: user.displayName ? user.displayName.split(' ')[0] : 'Nuevo',
                            Apellido: user.displayName ? user.displayName.split(' ').slice(1).join(' ') : 'Usuario',
                            Email: userEmail,
                            rol: 'cliente',
                            Tipo: 'Basica',
                            Creado: Timestamp.fromDate(fechaInicio),
                            SuscripcionHasta: Timestamp.fromDate(fechaFin),
                            Telefono: '',
                            Genero: 'Otro'
                        };
                        
                        await setDoc(userDocRef, newUser);
                        userData = newUser;
                        console.log("Nuevo cliente creado exitosamente.");
                    }

                    if (userData) {
                        const userRole = userData.rol || 'cliente';
                        console.log(`Usuario autenticado con rol: ${userRole}`);
                        switch (userRole) {
                            case 'administrador': window.location.href = 'dashboard.html'; break;
                            case 'recepcion': window.location.href = 'recepcion.html'; break;
                            case 'entrenador': window.location.href = 'entrenadores.html'; break;
                            default: window.location.href = 'usuarios.html'; break;
                        }
                    } else {
                        console.log("No se pudieron obtener los datos del usuario. Redirigiendo a portal de cliente.");
                        window.location.href = 'usuarios.html';
                    }
                } catch (error) {
                    console.error("Error al obtener o migrar el rol del usuario:", error);
                    showError("No se pudo verificar tu rol. Intenta de nuevo.");
                    // Opcional: cerrar sesión si hay un error crítico
                    // auth.signOut();
                    setLoading(false);
                }
            } else {
                console.log('No hay usuario autenticado.');
            }
        });

        // Evento para el inicio de sesión con Google
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            setLoading(true);
            try {
                await signInWithPopup(auth, provider);
                // La redirección la maneja onAuthStateChanged
            } catch (error) {
                // Mejoramos el log para ver el error específico de Firebase
                console.error("--- ERROR DE AUTENTICACIÓN CON GOOGLE ---");
                console.error("Código:", error.code);
                console.error("Mensaje:", error.message);
                console.error("Objeto de error completo:", error);
                console.error("-----------------------------------------");

                // Damos un mensaje más útil al usuario
                let friendlyMessage = 'No se pudo iniciar sesión con Google. Revisa la consola para más detalles.';
                if (error.code === 'auth/popup-closed-by-user') {
                    friendlyMessage = 'La ventana de inicio de sesión fue cerrada antes de completar el proceso.';
                } else if (error.code) {
                    friendlyMessage = `Error: ${error.code}. Revisa la consola para más detalles.`;
                }
                showError(friendlyMessage);
            } finally {
                setLoading(false);
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Entrenador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar {
            transition: transform 0.3s ease;
        }
        @media (max-width: 767px) {
            .sidebar {
                width: 80%;
                height: 100%;
                z-index: 1000;
            }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        #beforeAfterContainer {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 400px;
        }
        #beforeImage, #afterImage {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #slider {
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: ew-resize;
        }
        #sliderButton {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 9;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        /* NUEVA REGLA: imágenes dentro de la pestaña Progreso se muestran estáticas y más pequeñas */
        #progress-tab #beforeImage,
        #progress-tab #afterImage {
            position: static !important;
            width: 100%;
            max-width: 100%;
            height: 12rem; /* aprox h-48 */
            object-fit: cover;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="sidebar bg-indigo-800 text-white w-64 flex-shrink-0 fixed md:relative z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300">
            <button class="md:hidden absolute right-4 top-4 text-white" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
            <div class="p-4 flex items-center space-x-2 border-b border-indigo-700">
                <i class="fas fa-dumbbell text-2xl"></i>
                <h1 class="text-xl font-bold">FitCoach Pro</h1>
            </div>
            <nav class="p-4">
                <div class="mb-6">
                    <h2 class="text-xs uppercase tracking-wider text-indigo-300 mb-2">Clientes</h2>
                    <ul>
                        <li class="mb-1">
                            <button onclick="openTab('client-tab')" class="w-full text-left px-3 py-2 rounded hover:bg-indigo-700 flex items-center space-x-2 bg-indigo-700">
                                <i class="fas fa-users"></i>
                                <span>Mis Clientes</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="mb-6">
                    <h2 class="text-xs uppercase tracking-wider text-indigo-300 mb-2">Administración</h2>
                    <ul>
                        <li class="mb-1">
                            <button onclick="openTab('certifications-tab')" class="w-full text-left px-3 py-2 rounded hover:bg-indigo-700 flex items-center space-x-2">
                                <i class="fas fa-certificate"></i>
                                <span>Certificaciones</span>
                            </button>
                        </li>
                        <li class="mb-1">
                            <button onclick="openTab('bmi-tab')" class="w-full text-left px-3 py-2 rounded hover:bg-indigo-700 flex items-center space-x-2">
                                <i class="fas fa-calculator"></i>
                                <span>Calculadora IMC</span>
                            </button>
                        </li>
                    </ul>
                </div>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-indigo-700">
                <div id="sidebar-profile" class="relative flex items-center space-x-3 cursor-pointer" title="Mostrar opciones de perfil">
                    <img id="sidebar-profile-img" src="" alt="Profile" class="w-10 h-10 rounded-full object-cover border-2 border-indigo-100">
                    <div class="flex-1">
                        <p id="sidebar-profile-name" class="font-medium">Juan Pérez</p>
                        <p id="sidebar-profile-role" class="text-xs text-indigo-300">Entrenador Certificado</p>
                    </div>
                    <!-- Menú desplegable similar a "usuarios" (oculto por defecto) -->
                    <div id="profile-menu" class="absolute bottom-14 right-0 w-44 bg-white text-indigo-800 rounded-md shadow-lg hidden z-50 overflow-hidden">
                        <div class="px-3 py-2 border-b border-gray-100">
                            <p id="menu-name" class="text-sm font-medium">Juan Pérez</p>
                            <p id="menu-email" class="text-xs text-gray-500">usuario@ejemplo.com</p>
                        </div>
                        <button id="menu-signout" class="w-full text-left px-3 py-2 hover:bg-gray-100">Cerrar sesión</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <!-- Header -->
            <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                <button class="md:hidden text-gray-600" onclick="showSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="text-xl font-semibold text-gray-800" id="tab-title">Mis Clientes</h2>
                <div class="flex items-center space-x-4">
                </div>
            </header>

            <!-- Tab Contents -->
            <main class="p-6">
                <!-- Clients Tab -->
                <div id="client-tab" class="tab-content active">
                    <div class="mb-6 flex justify-between items-center">
                        <h3 class="text-lg font-medium">Lista de Clientes</h3>
                        <div class="relative">
                            <input type="text" id="search-client" 
                                   placeholder="Buscar cliente..." 
                                   class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="clients-container">
                        <!-- Client cards will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Client Details Modal -->
                <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-2 sm:p-4">
                    <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-auto mx-2 sm:mx-0">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-xl font-semibold" id="client-modal-title">Detalles del Cliente</h3>
                            <div class="flex items-center space-x-2">
                                <button onclick="closeClientModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <!-- Client Info -->
                            <div class="flex flex-col md:flex-row gap-6 mb-8">
                                <div class="flex-shrink-0">
                                    <img id="client-modal-image" src="" alt="Client" class="w-32 h-32 rounded-full object-cover border-4 border-indigo-100">
                                </div>
                                <div class="flex-1">
                                    <h4 id="client-modal-name" class="text-2xl font-bold mb-2"></h4>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <p class="text-sm text-gray-500">Objetivo</p>
                                            <p id="client-modal-goal" class="font-medium"></p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">Duración</p>
                                            <p id="client-modal-duration" class="font-medium"></p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">Telfono</p>
                                            <p id="client-modal-tel" class="font-medium"></p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">Edad</p>
                                            <p id="client-modal-age" class="font-medium"></p>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Notas</p>
                                        <textarea id="client-modal-notes" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Tabs -->
                            <div class="border-b border-gray-200 mb-6">
                                <nav class="flex space-x-8">
                                    <button onclick="openClientTab('metrics-tab')" class="client-tab-button py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">Métricas</button>
                                    <button onclick="openClientTab('progress-tab')" class="client-tab-button py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Progreso</button>
                                    <button onclick="openClientTab('medical-tab')" class="client-tab-button py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Historial Médico</button>
                                    <button onclick="openClientTab('routine-tab')" class="client-tab-button py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Rutina</button>
                                </nav>
                            </div>

                            <!-- Tab Contents -->
                            <div id="metrics-tab" class="client-tab-content">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div class="bg-white p-4 rounded-lg border">
                                        <h5 class="font-medium mb-4">Medidas Corporales</h5>
                                        <div class="space-y-3">
                                            <div class="flex justify-between">
                                                <span>Peso</span>
                                                <div class="flex items-center">
                                                    <input id="input-peso" type="number" class="w-16 p-1 border rounded text-right mr-2" placeholder="kg">
                                                    <span>kg</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Altura</span>
                                                <div class="flex items-center">
                                                    <input id="input-altura" type="number" class="w-16 p-1 border rounded text-right mr-2" placeholder="cm">
                                                    <span>cm</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>IMC</span>
                                                <span id="bmi-value">24.9</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>% Grasa</span>
                                                <div class="flex items-center">
                                                    <input id="input-grasa" type="number" class="w-16 p-1 border rounded text-right mr-2" placeholder="%">
                                                    <span>%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg border">
                                        <h5 class="font-medium mb-4">Rendimiento</h5>
                                        <div class="space-y-3">
                                            <div class="flex justify-between">
                                                <span>RM Press Banca</span>
                                                <div class="flex items-center">
                                                    <input id="input-press-banca" type="number" class="w-16 p-1 border rounded text-right mr-2" placeholder="kg">
                                                    <span>kg</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>RM Sentadilla</span>
                                                <div class="flex items-center">
                                                    <input id="input-sentadilla" type="number" class="w-16 p-1 border rounded text-right mr-2" placeholder="kg">
                                                    <span>kg</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Flexiones máx.</span>
                                                <div class="flex items-center">
                                                    <input id="input-flexiones" type="number" class="w-16 p-1 border rounded text-right mr-2" placeholder="rep.">
                                                    <span>rep.</span>
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>5km tiempo</span>
                                                <div class="flex items-center">
                                                    <input id="input-tiempo5km" type="text" class="w-16 p-1 border rounded text-right mr-2" placeholder="mm:ss">
                                                    <span>min</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <button onclick="saveClientChanges()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Guardar Cambios</button>
                                </div>
                            </div>

                            <div id="progress-tab" class="client-tab-content hidden">
                                <div class="mb-6">
                                    <h5 class="font-medium mb-4">Fotos de Progreso</h5>
                                    <!-- Muestra: foto inicial (primera subida) y última foto subida -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div class="bg-white p-4 rounded-lg border flex flex-col items-center">
                                            <p class="text-sm text-gray-600 mb-2">Foto inicial (primera subida)</p>
                                            <img id="beforeImage" src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?auto=format&fit=crop&w=600&q=80" alt="Before" class="w-full object-cover rounded">
                                        </div>
                                        <div class="bg-white p-4 rounded-lg border flex flex-col items-center">
                                            <p class="text-sm text-gray-600 mb-2">Última foto subida</p>
                                            <img id="afterImage" src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?auto=format&fit=crop&w=600&q=80" alt="After" class="w-full object-cover rounded">
                                        </div>
                                    </div>
                                </div>

                                <!-- Mantener indicador mínimo de progreso -->
                                <div id="upload-progress" class="hidden text-sm text-gray-600 mt-2">Cargando: <span id="upload-percent">0%</span></div>

                                <!-- Subir sólo: inputs para before/after -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Subir foto inicial</label>
                                        <div class="flex items-center">
                                            <input type="file" class="hidden" id="before-upload" accept="image/*">
                                            <button onclick="document.getElementById('before-upload').click()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-l-lg hover:bg-gray-200">
                                                <i class="fas fa-upload mr-2"></i>Seleccionar
                                            </button>
                                            <span id="before-filename" class="px-4 py-2 bg-gray-50 border-l border-gray-200 text-sm text-gray-500">Ningún archivo seleccionado</span>
                                        </div>
                                        <!-- Añadido: botón visible para confirmar la subida -->
                                        <div class="mt-2">
                                            <button id="before-upload-submit" disabled class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Subir foto inicial</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Subir última foto</label>
                                        <div class="flex items-center">
                                            <input type="file" class="hidden" id="after-upload" accept="image/*">
                                            <button onclick="document.getElementById('after-upload').click()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-l-lg hover:bg-gray-200">
                                                <i class="fas fa-upload mr-2"></i>Seleccionar
                                            </button>
                                            <span id="after-filename" class="px-4 py-2 bg-gray-50 border-l border-gray-200 text-sm text-gray-500">Ningún archivo seleccionado</span>
                                        </div>
                                        <!-- Añadido: botón visible para confirmar la subida -->
                                        <div class="mt-2">
                                            <button id="after-upload-submit" disabled class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Subir última foto</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Sin botón extra: la subida se realiza al seleccionar archivo -->
                            </div>

                            <div id="medical-tab" class="client-tab-content hidden">
                                <div class="bg-white p-4 rounded-lg border mb-6">
                                    <h5 class="font-medium mb-4">Historial Médico</h5>
                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-sm text-gray-500 mb-1">Condiciones médicas</p>
                                            <p class="font-medium">Ninguna conocida</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500 mb-1">Lesiones previas</p>
                                            <p class="font-medium">Esguince de tobillo derecho (2020)</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500 mb-1">Alergias</p>
                                            <p class="font-medium">Ninguna conocida</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500 mb-1">Medicamentos</p>
                                            <p class="font-medium">Ninguno actualmente</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500 mb-1">Notas adicionales</p>
                                            <p class="font-medium">El cliente reporta molestias ocasionales en la rodilla izquierda durante ejercicios de impacto.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-500">
                                    <p><i class="fas fa-info-circle mr-2"></i>El historial médico solo puede ser editado por el cliente desde su perfil.</p>
                                </div>
                            </div>

                            <div id="routine-tab" class="client-tab-content hidden">
                                <div class="mb-6">
                                    <h5 class="font-medium mb-4">Rutina Actual</h5>
                                    <div class="bg-white p-4 rounded-lg border">
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Objetivo de la rutina</label>
                                            <select class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option>Pérdida de peso</option>
                                                <option selected>Ganancia muscular</option>
                                                <option>Tonificación</option>
                                                <option>Preparación física</option>
                                                <option>Rehabilitación</option>
                                            </select>
                                        </div>
                                        <div class="mb-4">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia semanal</label>
                                            <select class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option>2 días</option>
                                                <option selected>3 días</option>
                                                <option>4 días</option>
                                                <option>5 días</option>
                                                <option>6 días</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Detalles de la rutina</label>
                                            <textarea class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="6">
Lunes (Pierna):
- Sentadillas 4x12
- Peso muerto 3x10
- Prensa 3x12
- Elevación de talones 4x15

Miércoles (Espalda/Bíceps):
- Dominadas asistidas 3x8
- Remo con barra 4x10
- Curl de bíceps 3x12
- Jalón al pecho 3x12

Viernes (Pecho/Tríceps):
- Press banca 4x10
- Fondos 3x12
- Aperturas 3x12
- Extensión de tríceps 3x15

Notas: Descansar 60-90 segundos entre series. Mantener buena forma en todos los ejercicios.
                                            </textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Actualizar Rutina</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Certifications Tab -->
                <div id="certifications-tab" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-medium">Certificaciones</h3>
                        <p class="text-gray-500">Sube tus certificaciones como entrenador y de entrenamiento médico.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h4 class="font-medium mb-4 flex items-center">
                                <i class="fas fa-certificate text-indigo-500 mr-2"></i>
                                Certificaciones de Entrenador
                            </h4>
                            <div class="space-y-4 mb-6">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                        <i class="fas fa-file-pdf text-indigo-600"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="font-medium">Certificación NSCA-CPT</p>
                                        <p class="text-sm text-gray-500">Válido hasta: 15/06/2025</p>
                                    </div>
                                    <button class="ml-auto text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                        <i class="fas fa-file-pdf text-indigo-600"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="font-medium">Certificación de Primeros Auxilios</p>
                                        <p class="text-sm text-gray-500">Válido hasta: 10/12/2023</p>
                                    </div>
                                    <button class="ml-auto text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subir nueva certificación</label>
                                <div class="flex items-center">
                                    <input type="file" class="hidden" id="certification-upload">
                                    <button onclick="document.getElementById('certification-upload').click()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-l-lg hover:bg-gray-200">
                                        <i class="fas fa-upload mr-2"></i>Seleccionar
                                    </button>
                                    <span id="cert-filename" class="px-4 py-2 bg-gray-50 border-l border-gray-200 text-sm text-gray-500">Ningún archivo seleccionado</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h4 class="font-medium mb-4 flex items-center">
                                <i class="fas fa-heartbeat text-red-500 mr-2"></i>
                                Certificaciones Médicas
                            </h4>
                            <div class="space-y-4 mb-6">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-red-100 flex items-center justify-center">
                                        <i class="fas fa-file-pdf text-red-600"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="font-medium">Certificación en Rehabilitación</p>
                                        <p class="text-sm text-gray-500">Válido hasta: 22/03/2026</p>
                                    </div>
                                    <button class="ml-auto text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subir nueva certificación médica</label>
                                <div class="flex items-center">
                                    <input type="file" class="hidden" id="medical-certification-upload">
                                    <button onclick="document.getElementById('medical-certification-upload').click()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-l-lg hover:bg-gray-200">
                                        <i class="fas fa-upload mr-2"></i>Seleccionar
                                    </button>
                                    <span id="medical-cert-filename" class="px-4 py-2 bg-gray-50 border-l border-gray-200 text-sm text-gray-500">Ningún archivo seleccionado</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border">
                        <h4 class="font-medium mb-4 flex items-center">
                            <i class="fas fa-graduation-cap text-yellow-500 mr-2"></i>
                            Otras Credenciales
                        </h4>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripción profesional</label>
                            <textarea class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="4">Entrenador personal certificado con 5 años de experiencia en fitness y rehabilitación. Especializado en entrenamiento funcional, pérdida de peso y preparación física para deportes. Enfoque en técnicas seguras y efectivas adaptadas a las necesidades individuales de cada cliente.</textarea>
                        </div>
                        <div class="flex justify-end">
                            <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Guardar Cambios</button>
                        </div>
                    </div>
                </div>

                <!-- Schedule Tab -->
                <div id="schedule-tab" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-medium">Horario de Atención</h3>
                        <p class="text-gray-500">Establece tus horarios disponibles para atender a clientes.</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-medium mb-4">Horario Semanal</h4>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <span class="w-24">Lunes</span>
                                        <div class="flex-1 flex items-center space-x-2">
                                            <input type="time" value="08:00" class="p-2 border rounded-lg">
                                            <span>a</span>
                                            <input type="time" value="14:00" class="p-2 border rounded-lg">
                                        </div>
                                        <button class="ml-4 text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="w-24">Martes</span>
                                        <div class="flex-1 flex items-center space-x-2">
                                            <input type="time" value="08:00" class="p-2 border rounded-lg">
                                            <span>a</span>
                                            <input type="time" value="14:00" class="p-2 border rounded-lg">
                                        </div>
                                        <button class="ml-4 text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="w-24">Miércoles</span>
                                        <div class="flex-1 flex items-center space-x-2">
                                            <input type="time" value="08:00" class="p-2 border rounded-lg">
                                            <span>a</span>
                                            <input type="time" value="14:00" class="p-2 border rounded-lg">
                                        </div>
                                        <button class="ml-4 text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="w-24">Jueves</span>
                                        <div class="flex-1 flex items-center space-x-2">
                                            <input type="time" value="08:00" class="p-2 border rounded-lg">
                                            <span>a</span>
                                            <input type="time" value="14:00" class="p-2 border rounded-lg">
                                        </div>
                                        <button class="ml-4 text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="w-24">Viernes</span>
                                        <div class="flex-1 flex items-center space-x-2">
                                            <input type="time" value="08:00" class="p-2 border rounded-lg">
                                            <span>a</span>
                                            <input type="time" value="14:00" class="p-2 border rounded-lg">
                                        </div>
                                        <button class="ml-4 text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="w-24">Sábado</span>
                                        <div class="flex-1 flex items-center space-x-2">
                                            <input type="time" value="09:00" class="p-2 border rounded-lg">
                                            <span>a</span>
                                            <input type="time" value="12:00" class="p-2 border rounded-lg">
                                        </div>
                                        <button class="ml-4 text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="w-24">Domingo</span>
                                        <div class="flex items-center">
                                            <span class="text-gray-400">No disponible</span>
                                        </div>
                                        <button class="ml-4 text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-medium mb-4">Horario Especial</h4>
                                <div class="space-y-4">
                                    <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <p class="font-medium">Día festivo</p>
                                                <p class="text-sm text-gray-500">15 de septiembre</p>
                                            </div>
                                            <button class="text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <input type="time" value="10:00" class="p-2 border rounded-lg">
                                            <span>a</span>
                                            <input type="time" value="13:00" class="p-2 border rounded-lg">
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Agregar horario especial</label>
                                    <div class="flex space-x-2">
                                        <input type="date" class="p-2 border rounded-lg flex-1">
                                        <input type="time" class="p-2 border rounded-lg">
                                        <span class="flex items-center">a</span>
                                        <input type="time" class="p-2 border rounded-lg">
                                        <button class="px-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Guardar Horario</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border">
                        <h4 class="font-medium mb-4">Próximas Sesiones</h4>
                        <div class="overflow-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <img class="h-10 w-10 rounded-full" src="https://randomuser.me/api/portraits/women/44.jpg" alt="">
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900">María González</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">15/09/2023</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">09:00 - 10:00</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Entrenamiento</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
                                            <button class="text-red-600 hover:text-red-900">Cancelar</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <img class="h-10 w-10 rounded-full" src="https://randomuser.me/api/portraits/men/22.jpg" alt="">
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900">Carlos Ruiz</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">16/09/2023</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">11:00 - 12:00</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Evaluación</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
                                            <button class="text-red-600 hover:text-red-900">Cancelar</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10">
                                                    <img class="h-10 w-10 rounded-full" src="https://randomuser.me/api/portraits/women/68.jpg" alt="">
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900">Ana Martínez</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">17/09/2023</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900">16:00 - 17:00</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Entrenamiento</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
                                            <button class="text-red-600 hover:text-red-900">Cancelar</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- BMI Calculator Tab -->
                <div id="bmi-tab" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-medium">Calculadora de IMC</h3>
                        <p class="text-gray-500">Calcula el Índice de Masa Corporal de tus clientes.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h4 class="font-medium mb-4">Calculadora</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Peso (kg)</label>
                                    <input type="number" id="weight" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej. 70">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Altura (cm)</label>
                                    <input type="number" id="height" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej. 175">
                                </div>
                                <div class="pt-2">
                                    <button onclick="calculateBMI()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Calcular IMC</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h4 class="font-medium mb-4">Resultado</h4>
                            <div id="bmi-result" class="text-center py-8">
                                <div class="text-gray-400">
                                    <i class="fas fa-calculator text-4xl mb-2"></i>
                                    <p>Ingresa los datos para calcular el IMC</p>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h5 class="font-medium mb-2">Clasificación del IMC</h5>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                                        <span class="text-sm flex-1">Menos de 18.5 - Bajo peso</span>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                        <span class="text-sm flex-1">18.5 a 24.9 - Peso normal</span>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></div>
                                        <span class="text-sm flex-1">25.0 a 29.9 - Sobrepeso</span>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                                        <span class="text-sm flex-1">30.0 o más - Obesidad</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
    // filepath: c:\Users\joabe\OneDrive\Documents\GitHub\Verano\entrenadores.html
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { 
        getFirestore,
        collection, 
        getDocs, 
        doc, 
        getDoc,
        updateDoc,
        setDoc,
        serverTimestamp,
        addDoc
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";
    import { 
        getAuth,
        onAuthStateChanged,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    let currentClientId = null;
    // Añadido: variables para guardar selección antes de subir
    let beforeSelectedFile = null;
    let afterSelectedFile = null;

    // Función para obtener elementos del DOM de manera segura
    function getElement(selector) {
        const element = document.querySelector(selector);
        if (!element) {
            console.error(`Elemento no encontrado: ${selector}`);
            throw new Error(`Elemento no encontrado: ${selector}`);
        }
        return element;
    }

    // Función para abrir pestañas dentro del modal
    function openClientTab(tabId) {
        try {
            document.querySelectorAll('.client-tab-button').forEach(button => {
                button.classList.remove('border-indigo-500', 'text-indigo-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            const activeButton = document.querySelector(`.client-tab-button[onclick*="${tabId}"]`);
            if (activeButton) {
                activeButton.classList.add('border-indigo-500', 'text-indigo-600');
                activeButton.classList.remove('border-transparent', 'text-gray-500');
            }
            
            document.querySelectorAll('.client-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            getElement(`#${tabId}`).classList.remove('hidden');
        } catch (error) {
            console.error("Error al cambiar pestaña:", error);
        }
    }

    // Función para cerrar el modal
    function closeClientModal() {
        getElement('#client-modal').classList.add('hidden');
    }

    // Función para obtener datos de clientes
    async function getClientsData() {
        try {
            const clientsCollection = collection(db, "usuarios");
            const clientsSnapshot = await getDocs(clientsCollection);
            return clientsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        } catch (error) {
            console.error("Error getting clients data:", error);
            return [];
        }
    }

    // Función para ver detalles del cliente
    async function viewClientDetails(clientId) {
        if (!clientId) {
            alert("No se proporcionó un ID de cliente válido");
            return;
        }
        
        currentClientId = clientId;
        
        try {
            const clientDoc = await getDoc(doc(db, "usuarios", clientId));
            
            if (!clientDoc.exists()) {
                alert("Cliente no encontrado");
                return;
            }
            
            const client = clientDoc.data();
            
            // Actualizar campos del modal
            getElement('#client-modal-title').textContent = `Detalles de ${client.Nombre || ''} ${client.Apellido || ''}`.trim();
            getElement('#client-modal-name').textContent = `${client.Nombre || ''} ${client.Apellido || ''}`.trim();
            getElement('#client-modal-tel').textContent = client.Telefono || 'No especificado';
            getElement('#client-modal-age').textContent = client.Estado || 'Sin estado';
            getElement('#client-modal-notes').value = client.Notas || '';
            
            if (client.Genero) {
                getElement('#client-modal-goal').textContent = client.Genero;
            }
            
            if (client.SuscripcionHasta) {
                const fechaSuscripcion = new Date(client.SuscripcionHasta.seconds * 1000);
                getElement('#client-modal-duration').textContent = fechaSuscripcion.toLocaleDateString();
            }
            
            // Cargar imagen
            const imgElement = getElement('#client-modal-image');
            imgElement.src = client.fotoURL || (client.Genero === 'Femenino' ? 
                '' : 
                '');
            
            // Cargar métricas
            await loadClientMetrics(clientId);
            // Añadido: cargar fotos de progreso si existen
            await loadClientProgress(clientId);

            // Mostrar el modal
            getElement('#client-modal').classList.remove('hidden');
            openClientTab('metrics-tab');
            
        } catch (error) {
            console.error("Error al cargar detalles del cliente:", error);
            alert("Error al cargar los detalles del cliente");
        }
    }

    // Cargar métricas del cliente
    async function loadClientMetrics(clientId) {
        if (!clientId) return;
        
        try {
            const metricsDoc = await getDoc(doc(db, 'metricas', clientId));
            if (!metricsDoc.exists()) return;
            
            const metrics = metricsDoc.data();
            // Usar ids directos para mayor fiabilidad
            if (metrics.peso !== undefined && document.getElementById('input-peso')) document.getElementById('input-peso').value = metrics.peso;
            if (metrics.altura !== undefined && document.getElementById('input-altura')) document.getElementById('input-altura').value = metrics.altura;
            if (metrics.grasa !== undefined && document.getElementById('input-grasa')) document.getElementById('input-grasa').value = metrics.grasa;
            if (metrics.pressBanca !== undefined && document.getElementById('input-press-banca')) document.getElementById('input-press-banca').value = metrics.pressBanca;
            if (metrics.sentadilla !== undefined && document.getElementById('input-sentadilla')) document.getElementById('input-sentadilla').value = metrics.sentadilla;
            if (metrics.flexiones !== undefined && document.getElementById('input-flexiones')) document.getElementById('input-flexiones').value = metrics.flexiones;
            if (metrics.tiempo5km !== undefined && document.getElementById('input-tiempo5km')) document.getElementById('input-tiempo5km').value = metrics.tiempo5km;
            
            if (metrics.peso && metrics.altura) {
                const bmi = (metrics.peso / Math.pow(metrics.altura/100, 2)).toFixed(1);
                getElement('#bmi-value').textContent = bmi;
            }
        } catch (error) {
            console.error("Error al cargar métricas:", error);
        }
    }

    // Añadido: cargar fotos de progreso guardadas en Firestore y mostrarlas
    async function loadClientProgress(clientId) {
        if (!clientId) return;
        try {
            const progDoc = await getDoc(doc(db, 'progresos', clientId));
            if (!progDoc.exists()) return;
            const data = progDoc.data();
            if (data.beforeURL) getElement('#beforeImage').src = data.beforeURL;
            if (data.afterURL) getElement('#afterImage').src = data.afterURL;
        } catch (error) {
            console.error("Error al cargar progreso:", error);
        }
    }

    // Reemplazo de la función uploadImage para usar uploadBytes (más simple) y mejor manejo de errores
    async function uploadImage(file, clientId, type) {
		if (!file || !clientId) throw new Error('Falta archivo o clientId');

		// Comprobar doc existente para comportamiento de "before"
		const progDocRef = doc(db, 'progresos', clientId);
		const progSnap = await getDoc(progDocRef);
		const progData = progSnap.exists() ? progSnap.data() : {};

		if (type === 'before' && progData && progData.beforeURL) {
			throw new Error('Ya existe una foto inicial. Si deseas reemplazarla elimina primero la existente.');
		}

		// Si tienes configurado un endpoint para subir a Drive, usarlo
		if (DRIVE_UPLOAD_URL && DRIVE_UPLOAD_URL.trim() !== "") {
			try {
				// Leer archivo como base64 (para enviar JSON fácilmente)
				const base64 = await new Promise((resolve, reject) => {
					const reader = new FileReader();
					reader.onload = () => {
						const result = reader.result.split(',')[1]; // quitar prefijo data:*/*;base64,
						resolve(result);
					};
					reader.onerror = reject;
					reader.readAsDataURL(file);
				});

				// Enviar JSON con filename, contentType y base64
				const payload = {
					filename: file.name,
					contentType: file.type || 'image/jpeg',
					fileBase64: base64,
					type: type,
					clientId: clientId
				};

				const resp = await fetch(DRIVE_UPLOAD_URL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});

				if (!resp.ok) {
					const text = await resp.text();
					throw new Error('Error en upload a Drive: ' + resp.status + ' ' + text);
				}

				const data = await resp.json();
				if (!data || !data.url) throw new Error('Respuesta inválida del servidor de Drive');

				// Guardar la URL devuelta en Firestore (igual que antes)
				const update = { fecha: serverTimestamp() };
				if (type === 'before' && !progData.beforeURL) update.beforeURL = data.url;
				if (type === 'after') update.afterURL = data.url;
				await setDoc(progDocRef, update, { merge: true });

				// Actualizar UI
				if (type === 'before' && !progData.beforeURL) {
					const beforeImg = document.getElementById('beforeImage');
					if (beforeImg) beforeImg.src = data.url;
				}
				if (type === 'after') {
					const afterImg = document.getElementById('afterImage');
					if (afterImg) afterImg.src = data.url;
				}

				return data.url;
			} catch (err) {
				console.error('Error subiendo a Drive:', err);
				throw err;
			}
		}

		// Fallback: subir a Firebase Storage (implementación previa)
		const filename = `${type}_${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
		const imageRef = storageRef(storage, `progresos/${clientId}/${filename}`); // storageRef is now imported from firebase-storage
		const metadata = { contentType: file.type || 'image/jpeg' };

		try {
			await uploadBytes(storageRef, file, metadata);
			const downloadURL = await getDownloadURL(storageRef);
			const update = { fecha: serverTimestamp() };
			if (type === 'before' && !progData.beforeURL) update.beforeURL = downloadURL;
			if (type === 'after') update.afterURL = downloadURL;
			await setDoc(progDocRef, update, { merge: true });

			if (type === 'before' && !progData.beforeURL) {
				const beforeImg = document.getElementById('beforeImage');
				if (beforeImg) beforeImg.src = downloadURL;
			}
			if (type === 'after') {
				const afterImg = document.getElementById('afterImage');
				if (afterImg) afterImg.src = downloadURL;
			}
			return downloadURL;
		} catch (err) {
			console.error('Error en upload a Firebase:', err);
			throw err;
		}
	}

    // Guardar cambios del cliente (VERSIÓN CORREGIDA)
    async function saveClientChanges() {
        if (!currentClientId) {
            alert("No hay un cliente seleccionado");
            return;
        }
        
        try {
            // Obtener valores con ids
            const peso = parseFloat(getElement('#input-peso').value) || 0;
            const altura = parseFloat(getElement('#input-altura').value) || 0;
            const grasa = parseFloat(getElement('#input-grasa').value) || 0;
            
            if (peso <= 0 || altura <= 0) {
                alert("Por favor ingresa valores válidos para peso y altura");
                return;
            }
            
            // Calcular IMC
            const bmi = (peso / Math.pow(altura/100, 2)).toFixed(1);
            getElement('#bmi-value').textContent = bmi;

            // Preparar datos para guardar
            const clientData = {
                Notas: getElement('#client-modal-notes').value,
                ultimaActualizacion: serverTimestamp()
            };
            
            const metricsData = {
                peso: peso,
                altura: altura,
                grasa: grasa,
                pressBanca: parseFloat(getElement('#input-press-banca').value) || 0,
                sentadilla: parseFloat(getElement('#input-sentadilla').value) || 0,
                flexiones: parseInt(getElement('#input-flexiones').value) || 0,
                tiempo5km: getElement('#input-tiempo5km').value || '00:00',
                imc: bmi,
                fechaActualizacion: serverTimestamp()
            };
            
            // Guardar datos
            await updateDoc(doc(db, "usuarios", currentClientId), clientData);
            await setDoc(doc(db, 'metricas', currentClientId), metricsData, { merge: true });
            
            alert("Cambios guardados exitosamente!");
        } catch (error) {
            console.error("Error al guardar cambios:", error);
            alert("Error al guardar cambios. Por favor verifica los datos.");
        }
    }

    // Función para mostrar los clientes en la UI
    async function displayClients() {
        try {
            const clients = await getClientsData();
            const container = getElement('#clients-container');
            container.innerHTML = '';
            
            if (clients.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No hay clientes registrados</p>';
                return;
            }
            
            clients.forEach(client => {
                const nombreCompleto = `${client.Nombre || ''} ${client.Apellido || ''}`.trim();
                const clientCard = document.createElement('div');
                clientCard.className = 'bg-white rounded-lg shadow-md p-4 flex flex-col';
                clientCard.innerHTML = `
                    <div class="flex-1 flex items-center space-x-4 mb-4">
                        
                             
                            <p class="text-md font-semibold text-gray-800">${nombreCompleto || 'Sin nombre'}</p>
                            <p class="text-sm text-gray-500">Género: ${client.Genero || 'No especificado'}</p>
                            <p class="text-sm text-gray-500">Teléfono: ${client.Telefono || 'No especificado'}</p>
                            <p class="text-sm text-gray-500">Suscripción hasta: ${
                                client.SuscripcionHasta ? 
                                new Date(client.SuscripcionHasta.seconds * 1000).toLocaleDateString() : 
                                'No especificado'
                            }</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <button onclick="viewClientDetails('${client.id}')" 
                                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            Ver Detalles
                        </button>
                    </div>
                `;
                container.appendChild(clientCard);
            });
        } catch (error) {
            console.error("Error al mostrar clientes:", error);
            getElement('#clients-container').innerHTML = '<p class="text-red-500">Error al cargar los clientes</p>';
        }
    }

    // Función para filtrar clientes
    async function searchClients(searchTerm) {
        try {
            const clients = await getClientsData();
            const filteredClients = clients.filter(client => {
                const fullName = `${client.Nombre || ''} ${client.Apellido || ''}`.toLowerCase();
                return fullName.includes(searchTerm.toLowerCase());
            });
            
            const container = getElement('#clients-container');
            container.innerHTML = '';
            
            if (filteredClients.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No se encontraron clientes</p>';
                return;
            }
            
            filteredClients.forEach(client => {
                // Reutilizar el mismo formato de tarjeta que displayClients
                const nombreCompleto = `${client.Nombre || ''} ${client.Apellido || ''}`.trim();
                const clientCard = document.createElement('div');
                clientCard.className = 'bg-white rounded-lg shadow-md p-4 flex flex-col';
                clientCard.innerHTML = `
                    <div class="flex-1 flex items-center space-x-4 mb-4">
                        <img src="${client.fotoURL || 'https://randomuser.me/api/portraits/men/47.jpg'}" 
                             alt="Client Image" class="w-16 h-16 rounded-full object-cover">
                        <div class="flex-1">
                            <p class="text-md font-semibold text-gray-800">${nombreCompleto || 'Sin nombre'}</p>
                            <p class="text-sm text-gray-500">Género: ${client.Genero || 'No especificado'}</p>
                            <p class="text-sm text-gray-500">Teléfono: ${client.Telefono || 'No especificado'}</p>
                            <p class="text-sm text-gray-500">Suscripción hasta: ${
                                client.SuscripcionHasta ? 
                                new Date(client.SuscripcionHasta.seconds * 1000).toLocaleDateString() : 
                                'No especificado'
                            }</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <button onclick="viewClientDetails('${client.id}')" 
                                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            Ver Detalles
                        </button>
                    </div>
                `;
                container.appendChild(clientCard);
            });
        } catch (error) {
            console.error("Error al buscar clientes:", error);
            getElement('#clients-container').innerHTML = '<p class="text-red-500">Error al buscar clientes</p>';
        }
    }

    // Listener para mostrar nombre y foto de Google en el sidebar (y en el menú)
    onAuthStateChanged(auth, (user) => {
        const nameEl = document.getElementById('sidebar-profile-name');
        const roleEl = document.getElementById('sidebar-profile-role');
        const imgEl = document.getElementById('sidebar-profile-img');
        const menuName = document.getElementById('menu-name');
        const menuEmail = document.getElementById('menu-email');

        if (user) {
            if (nameEl) nameEl.textContent = user.displayName || user.email || 'Usuario';
            if (imgEl) imgEl.src = user.photoURL || imgEl.src;
            if (menuName) menuName.textContent = user.displayName || 'Usuario';
            if (menuEmail) menuEmail.textContent = user.email || '';

            // Verificar rol para asegurar que es un entrenador
            const checkRole = async () => {
                const userDocRef = doc(db, "usuarios", user.uid);
                let userDoc = await getDoc(userDocRef);
                let userData = null;

                if (userDoc.exists()) {
                    userData = userDoc.data();
                } else {
                    const q = query(collection(db, "usuarios"), where("Email", "==", user.email.toLowerCase()));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        userData = querySnapshot.docs[0].data();
                    }
                }

                if (userData && (userData.rol === 'entrenador' || userData.rol === 'admin' || userData.rol === 'administrador')) {
                    if (roleEl) roleEl.textContent = 'Entrenador Certificado';
                } else {
                    // Si no es entrenador, redirigir
                    window.location.href = 'index.html';
                }
            };
            checkRole();
        } else {
            // Si no hay usuario, redirigir al login
            window.location.href = 'index.html';
        }
    });
    
    // Función para cerrar sesión
    async function signOutUser() {
        try {
            await signOut(auth);
            // Después de cerrar sesión, redirigir a la página principal (index)
            location.replace('index.html');
        } catch (err) {
            console.error('Error cerrando sesión:', err);
            alert('No se pudo cerrar sesión. Intenta nuevamente.');
        }
    }

    // Hacer disponible globalmente
    window.signOutUser = signOutUser;

    // Mostrar/ocultar el menú desplegable al hacer click sobre el perfil; ocultar al click fuera
    function setupProfileToggle() {
        const profile = document.getElementById('sidebar-profile');
        const menu = document.getElementById('profile-menu');
        const menuSignout = document.getElementById('menu-signout');
        if (!profile || !menu) return;

        // Asegurar oculto inicial
        menu.classList.add('hidden');

        profile.addEventListener('click', (e) => {
            e.stopPropagation();
            menu.classList.toggle('hidden');
        });

        // Click sobre "Cerrar sesión" del menú
        if (menuSignout) {
            menuSignout.addEventListener('click', (e) => {
                e.stopPropagation();
                signOutUser();
            });
        }

        // Click fuera: ocultar menú
        document.addEventListener('click', (e) => {
            if (!profile.contains(e.target)) {
                if (!menu.classList.contains('hidden')) {
                    menu.classList.add('hidden');
                }
            }
        });
    }

    // Hacer las funciones disponibles globalmente
    // Función para cambiar pestañas principales (cliente, certificaciones, IMC, etc.)
    function openTab(tabId) {
        try {
            // Ocultar todas las pestañas y remover 'active'
            document.querySelectorAll('.tab-content').forEach(tc => {
                tc.classList.add('hidden');
                tc.classList.remove('active');
            });

            // Mostrar la pestaña seleccionada
            const target = document.getElementById(tabId);
            if (target) {
                target.classList.remove('hidden');
                target.classList.add('active');
            }

            // Resetear estilo de todos los botones del sidebar
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('bg-indigo-700');
                btn.classList.add('hover:bg-indigo-700');
            });

            // Activar el botón correspondiente
            const activeBtn = document.querySelector(`button[onclick*="${tabId}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-indigo-700');
                activeBtn.classList.remove('hover:bg-indigo-700');
            }

            // Actualizar título del header
            const titleMap = {
                'client-tab': 'Mis Clientes',
                'certifications-tab': 'Certificaciones',
                'bmi-tab': 'Calculadora IMC',
                'schedule-tab': 'Horario de Atención'
            };
            const tabTitleEl = document.getElementById('tab-title');
            if (tabTitleEl) {
                tabTitleEl.textContent = titleMap[tabId] || activeBtn?.querySelector('span')?.textContent || tabTitleEl.textContent;
            }
        } catch (err) {
            console.error('openTab error:', err);
        }
    }

    // Mostrar/ocultar sidebar en móviles
    function toggleSidebar() {
        const sb = document.querySelector('.sidebar');
        if (!sb) return;
        sb.classList.toggle('-translate-x-full');
    }

    // Forzar mostrar sidebar (usado en algunos botones)
    function showSidebar() {
        const sb = document.querySelector('.sidebar');
        if (!sb) return;
        sb.classList.remove('-translate-x-full');
    }
     window.viewClientDetails = viewClientDetails;
     window.saveClientChanges = saveClientChanges;
     window.openClientTab = openClientTab;
     window.openTab = openTab;
     window.toggleSidebar = toggleSidebar;
     window.showSidebar = showSidebar;
     window.closeClientModal = closeClientModal;
     window.displayClients = displayClients;
     window.showProgressTab = showProgressTab; // Exponer la nueva función

    // Calculadora de IMC: lee weight/height, muestra resultado y clasificación
    function calculateBMI() {
        const wEl = document.getElementById('weight');
        const hEl = document.getElementById('height');
        const resEl = document.getElementById('bmi-result');
        if (!wEl || !hEl || !resEl) return;
        const weight = parseFloat(wEl.value);
        const height = parseFloat(hEl.value);
        if (!(weight > 0) || !(height > 0)) {
            resEl.innerHTML = '<div class="text-red-500">Ingresa peso y altura válidos</div>';
            return;
        }
        const bmi = weight / Math.pow(height/100, 2);
        const bmiStr = bmi.toFixed(1);
        let clas = '';
        if (bmi < 18.5) clas = 'Bajo peso';
        else if (bmi < 25) clas = 'Peso normal';
        else if (bmi < 30) clas = 'Sobrepeso';
        else clas = 'Obesidad';
        resEl.innerHTML = `
            <div class="text-indigo-800">
                <div class="text-3xl font-bold mb-1">${bmiStr}</div>
                <div class="text-sm">${clas}</div>
            </div>
        `;
    }
    window.calculateBMI = calculateBMI;
    
    // Subir certificaciones: sube a Storage y guarda referencia en Firestore
    async function uploadCertification(file, type = 'general') {
        if (!file) throw new Error('No hay archivo');
        const user = auth.currentUser;
        if (!user) {
            alert('Debes iniciar sesión para subir certificaciones.');
            return;
        } // storageRef is now imported from firebase-storage
        const uid = user.uid;
        const filename = `${type}_${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
        const certStorageRef = storageRef(storage, `certificaciones/${uid}/${filename}`); 
        try {
            await uploadBytes(certStorageRef, file, { contentType: file.type || 'application/octet-stream' });
            const url = await getDownloadURL(certStorageRef);
            // Guardar registro en Firestore (colección 'certificaciones')
            await addDoc(collection(db, 'certificaciones'), {
                uid,
                type,
                filename: file.name,
                url,
                uploadedAt: serverTimestamp()
            });
            return url;
        } catch (err) {
            console.error('Error subiendo certificación:', err);
            throw err;
        }
    }



    // Inicializar la aplicación
    document.addEventListener('DOMContentLoaded', () => {
        displayClients();
        setupProfileToggle();
        
        // Añadir listener para búsqueda
        const searchInput = document.getElementById('search-client');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim();
                if (searchTerm === '') {
                    displayClients(); // Mostrar todos si no hay término de búsqueda
                } else {
                    searchClients(searchTerm);
                }
            });
        }
        
        // Listeners para inputs de certificaciones
       const certInput = document.getElementById('certification-upload');
       const medCertInput = document.getElementById('medical-certification-upload');
       const certFilename = document.getElementById('cert-filename');
       const medCertFilename = document.getElementById('medical-cert-filename');

       if (certInput) {
           certInput.addEventListener('change', async (e) => {
               const file = e.target.files && e.target.files[0];
               if (!file) return;
               certFilename.textContent = file.name;
               try {
                   certFilename.textContent = 'Subiendo...';
                   await uploadCertification(file, 'general');
                   certFilename.textContent = 'Subida correctamente';
               } catch (err) {
                   certFilename.textContent = 'Error al subir';
                   alert('Error al subir certificación: ' + (err.message || err));
               } finally {
                   certInput.value = '';
               }
           });
       }

       if (medCertInput) {
           medCertInput.addEventListener('change', async (e) => {
               const file = e.target.files && e.target.files[0];
               if (!file) return;
               medCertFilename.textContent = file.name;
               try {
                   medCertFilename.textContent = 'Subiendo...';
                   await uploadCertification(file, 'medical');
                   medCertFilename.textContent = 'Subida correctamente';
               } catch (err) {
                   medCertFilename.textContent = 'Error al subir';
                   alert('Error al subir certificación médica: ' + (err.message || err));
               } finally {
                                     medCertInput.value = '';
               }
           });
       }
    });
    // Nueva función: abre la pestaña de progreso y enfoca los inputs de subida
	function showProgressTab() {
		try {
			openClientTab('progress-tab');
			// esperar un tick para que el DOM muestre la pestaña
			setTimeout(() => {
				// desplazar la vista dentro del modal hacia la sección de progreso si existe
				const progressEl = document.getElementById('progress-tab');
				if (progressEl) progressEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

				// intentar enfocar el botón de subir inicial para facilitar la acción
				const beforeBtn = document.querySelector('#before-upload') || document.getElementById('before-upload');
							if (beforeBtn) {
					// mostrar nombre del archivo no aplica aquí; trigger visual opcional
					const uploadTrigger = document.querySelector("button[onclick*=\"before-upload\"]");
					if (uploadTrigger) uploadTrigger.focus();
				}
			}, 150);
		} catch (e) {
			console.error('Error al abrir pestaña Progreso:', e);
		}
	}
</script>
</body>
</html>
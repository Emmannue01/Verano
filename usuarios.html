<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGym - Portal de Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .animate-pulse-slow {
            animation: pulse 3s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Header -->
    <header class="bg-indigo-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-dumbbell text-2xl text-yellow-400"></i>
                <h1 class="text-2xl font-bold">My<span class="text-yellow-400">Gym</span></h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button id="profileBtn" class="flex items-center space-x-2 focus:outline-none">
                        <img id="userAvatar" class="h-10 w-10 rounded-full" src="https://i.pravatar.cc/40" alt="User profile">
                        <span id="userName" class="hidden md:inline">Usuario</span>
                        <i class="fas fa-chevron-down text-xs hidden md:inline"></i>
                    </button>
                    <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                        <a href="#" id="logoutButton" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-100">Cerrar sesión</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Welcome Banner -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl shadow-lg p-6 mb-6 text-white">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h2 id="welcomeMessage" class="text-2xl font-bold mb-2">Cargando...</h2>
                    <p id="membershipStatus" class="mb-4">Verificando estado de membresía...</p>
                    <div class="flex space-x-2">
                        <span id="membershipPlan" class="bg-white/20 px-3 py-1 rounded-full text-sm">Plan: ...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Progress Card -->
            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Tu progreso</h3>
                    <!-- Toggle Semana/Mes -->
                    <div class="flex bg-gray-200 rounded-full p-1 text-sm">
                        <button id="vistaSemanaBtn" class="px-3 py-1 rounded-full bg-white text-indigo-600 shadow">Semana</button>
                        <button id="vistaMesBtn" class="px-3 py-1 rounded-full text-gray-600">Mes</button>
                    </div>
                </div>
                <div class="flex flex-col items-center flex-grow justify-center">
                    <div id="progressLoader" class="relative w-32 h-32 mb-4 flex items-center justify-center">
                         <i class="fas fa-spinner fa-spin text-indigo-500 text-4xl"></i>
                    </div>
                    <div id="progressContent" class="hidden w-full flex flex-col items-center">
                        <div class="relative w-32 h-32 mb-4">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="text-gray-200" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                            <circle id="progressCircle" class="text-yellow-400 progress-ring__circle" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" 
                                    stroke-dasharray="251.2" stroke-dashoffset="251.2" />
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="progressPercentage" class="text-2xl font-bold">0%</span>
                        </div>
                    </div>
                        <div class="w-full">
                            <div class="flex justify-between items-center text-sm mb-2">
                                <span>Objetivo:</span>
                                <div class="flex items-center space-x-2">
                                    <button id="decreaseGoal" class="w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 flex items-center justify-center">-</button>
                                    <span id="goalValue" class="font-bold w-4 text-center">5</span>
                                    <span id="goalUnit">días</span>
                                    <button id="increaseGoal" class="w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 flex items-center justify-center">+</button>
                                </div>
                            </div>
                            <div class="flex justify-between text-sm mb-1">
                                <span id="progressText">0/5</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progressBar" class="bg-indigo-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics Card -->
            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg">Tus métricas</h3>
                    <span id="metricsMonth" class="text-sm text-gray-500">Cargando...</span>
                </div>
                <div id="metricsLoader" class="text-center py-8 flex-grow flex items-center justify-center">
                    <i class="fas fa-spinner fa-spin text-indigo-500 text-2xl"></i>
                </div>
                <!-- Contenedor para métricas inyectadas dinámicamente por el entrenador -->
                <div id="metricsContent" class="hidden space-y-4 flex-grow">
                    <div id="dynamicMetricsContainer"></div>
                </div>
                <!-- botón de actualización eliminado: métricas solo definidas por el entrenador -->
             </div>
         </div>

        <!-- Nueva card: Altura / Peso / IMC (separada de "Tus métricas") -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center">
                <h4 class="font-semibold text-lg mb-2">Peso</h4>
                <div id="weightValue" class="text-2xl font-bold">-- kg</div>
                
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center">
                <h4 class="font-semibold text-lg mb-2">Altura</h4>
                <div id="heightValue" class="text-2xl font-bold">-- cm</div>
             
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center">
                <h4 class="font-semibold text-lg mb-2">IMC</h4>
                <div id="bmiValue" class="text-2xl font-bold">--</div>
               
            </div>
        </div>

    </main>

    <!-- modal de cliente eliminado: el usuario no puede añadir métricas -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, doc, getDoc, onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            // IMPORTANTE: Reemplaza este objeto completo con la configuración de tu proyecto
            apiKey: "AIzaSyBE7XnFDoaC7qPY8nykIGI-SCCMM6P_iG0",
            authDomain: "gymrats-d16eb.firebaseapp.com",
            projectId: "gymrats-d16eb",
            storageBucket: "gymrats-d16eb.appspot.com",
            messagingSenderId: "106526343668278361492",
            appId: "1:106526343668278361492:web:abcd1234efgh5678"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const dbRTDB = getDatabase(app);

        // --- Guardia de Autenticación para Clientes ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuario autenticado, puede quedarse.
                console.log("Acceso de cliente concedido.");

                // Actualizar UI con datos del usuario
                const userNameSpan = document.getElementById('userName');
                const userAvatarImg = document.getElementById('userAvatar');
                if (userNameSpan) {
                    userNameSpan.textContent = user.displayName || user.email.split('@')[0];
                }
                if (userAvatarImg && user.photoURL) {
                    userAvatarImg.src = user.photoURL;
                }

                // Cargar datos específicos del cliente desde Firestore
                try {
                    const userDocRef = doc(db, "usuarios", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const welcomeMessage = document.getElementById('welcomeMessage');
                        const membershipStatus = document.getElementById('membershipStatus');
                        const membershipPlan = document.getElementById('membershipPlan');

                        welcomeMessage.textContent = `¡Bienvenido de nuevo, ${userData.Nombre || 'Usuario'}!`;
                        
                        if (userData.SuscripcionHasta) {
                            const fechaFin = userData.SuscripcionHasta.toDate();
                            membershipStatus.textContent = `Tu membresía está activa hasta el ${fechaFin.toLocaleDateString('es-ES')}`;
                        }
                        membershipPlan.textContent = `Plan: ${userData.Tipo || 'Básico'}`;

                        // El UID para las lecturas es el que está guardado en el documento (el manual),
                        // no necesariamente el UID de autenticación de Google.
                        const checkinUid = userData.uid || user.uid;
                        inicializarProgreso(checkinUid);
                        inicializarMetricas(checkinUid);
                    }
                } catch (error) {
                    console.error("Error al cargar datos del usuario:", error);
                }
            } else {
                // No hay usuario, lo expulsamos.
                console.log("Usuario no autenticado, redirigiendo a login.");
                window.location.href = 'index.html';
            }
        });

        // --- Funcionalidad de Cerrar Sesión ---
        document.getElementById('logoutButton').addEventListener('click', (e) => {
          e.preventDefault();
          signOut(auth).catch(error => console.error('Error al cerrar sesión:', error));
        });

        // --- Funcionalidad del Dropdown de Perfil ---
        const profileBtn = document.getElementById('profileBtn');
        const profileDropdown = document.getElementById('profileDropdown');

        profileBtn.addEventListener('click', () => {
            profileDropdown.classList.toggle('hidden');
        });

        // Cerrar el dropdown si se hace clic fuera de él
        window.addEventListener('click', (e) => {
            if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                profileDropdown.classList.add('hidden');
            }
        });

        // --- Lógica para la tarjeta de Progreso ---
        function inicializarProgreso(uid) {
            const decreaseGoalBtn = document.getElementById('decreaseGoal');
            const increaseGoalBtn = document.getElementById('increaseGoal');
            const goalValueEl = document.getElementById('goalValue');
            const goalUnitEl = document.getElementById('goalUnit');
            const progressTextEl = document.getElementById('progressText');
            const progressPercentageEl = document.getElementById('progressPercentage');
            const progressBarEl = document.getElementById('progressBar');
            const progressCircleEl = document.getElementById('progressCircle');
            const progressLoader = document.getElementById('progressLoader');
            const progressContent = document.getElementById('progressContent');

            const circleCircumference = 251.2;
            let vistaActual = 'semana';
            // Cargar metas desde el almacenamiento local o usar valores por defecto
            let metaSemanal = parseInt(localStorage.getItem(`metaSemanal_${uid}`)) || 5;
            let metaMensual = parseInt(localStorage.getItem(`metaMensual_${uid}`)) || 20;
            let allLecturasData = {}; // Almacena los datos de las lecturas en tiempo real

            const cambiarVista = (nuevaVista) => {
                vistaActual = nuevaVista;
                if (vistaActual === 'semana') {
                    vistaSemanaBtn.classList.add('bg-white', 'text-indigos-600', 'shadow');
                    vistaMesBtn.classList.remove('bg-white', 'text-indigo-600', 'shadow');
                    vistaMesBtn.classList.add('text-gray-600');
                } else {
                    vistaMesBtn.classList.add('bg-white', 'text-indigo-600', 'shadow');
                    vistaSemanaBtn.classList.remove('bg-white', 'text-indigo-600', 'shadow');
                    vistaSemanaBtn.classList.add('text-gray-600');
                }
                cargarDatosProgreso();
            };

            const ajustarMeta = (ajuste) => {
                if (vistaActual === 'semana') {
                    metaSemanal = Math.max(1, metaSemanal + ajuste);
                    localStorage.setItem(`metaSemanal_${uid}`, metaSemanal);
                } else {
                    metaMensual = Math.max(1, metaMensual + ajuste);
                    localStorage.setItem(`metaMensual_${uid}`, metaMensual);
                }
                cargarDatosProgreso(); // Recalcular y mostrar con la nueva meta
            };

            const actualizarUI = (progreso, meta) => {
                const porcentaje = meta > 0 ? Math.min(100, (progreso / meta) * 100) : 0;
                
                goalValueEl.textContent = meta;
                goalUnitEl.textContent = 'visitas';
                progressTextEl.textContent = `${progreso}/${meta}`;
                
                progressPercentageEl.textContent = `${Math.round(porcentaje)}%`;
                progressBarEl.style.width = `${porcentaje}%`;
                
                const offset = circleCircumference - (porcentaje / 100) * circleCircumference;
                progressCircleEl.style.strokeDashoffset = offset;
            };

            const cargarDatosProgreso = () => {
                progressLoader.style.display = 'flex';
                progressContent.classList.add('hidden');

                const ahora = new Date();
                let inicio, fin;
                const meta = vistaActual === 'semana' ? metaSemanal : metaMensual;

                if (vistaActual === 'semana') {
                    // Lógica de cálculo de semana corregida para mayor robustez.
                    const hoy = new Date(ahora);
                    const diaDeLaSemana = hoy.getDay(); // 0=Domingo, 1=Lunes...
                    // Calcula el día del mes para el lunes de esta semana.
                    const diaLunes = hoy.getDate() - diaDeLaSemana + (diaDeLaSemana === 0 ? -6 : 1);

                    inicio = new Date(hoy.getFullYear(), hoy.getMonth(), diaLunes, 0, 0, 0, 0);
                    fin = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate() + 6, 23, 59, 59, 999);
                } else { // Mes
                    inicio = new Date(ahora.getFullYear(), ahora.getMonth(), 1, 0, 0, 0, 0);
                    fin = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 0, 23, 59, 59, 999);
                }

                let progreso = 0;
                if (allLecturasData) {
                    const registrosUsuario = Object.values(allLecturasData).filter(reg => {
                        const esUsuarioCorrecto = reg.uid === uid || reg.id === uid;
                        if (!esUsuarioCorrecto || !reg.timestamp) return false;

                        const fechaRegistro = new Date(reg.timestamp);
                        return !isNaN(fechaRegistro) && fechaRegistro >= inicio && fechaRegistro <= fin;
                    });

                    // Se cuentan las visitas completas (entrada/salida), por eso se divide entre 2.
                    progreso = Math.floor(registrosUsuario.length / 2);
                }
                actualizarUI(progreso, meta);

                progressLoader.style.display = 'none';
                progressContent.classList.remove('hidden');
                progressContent.classList.add('w-full', 'flex', 'flex-col', 'items-center');
            };

            // Se establece un listener para obtener las lecturas en tiempo real.
            const lecturasRef = ref(dbRTDB, 'lecturas');
            onValue(lecturasRef, (snapshot) => {
                allLecturasData = snapshot.val() || {};
                cargarDatosProgreso(); // Actualiza la UI cada vez que los datos cambian.
            }, (error) => {
                console.error("Error al obtener el progreso en tiempo real:", error);
                actualizarUI(0, vistaActual === 'semana' ? metaSemanal : metaMensual);
            });

            // Event Listeners
            vistaSemanaBtn.addEventListener('click', () => cambiarVista('semana'));
            vistaMesBtn.addEventListener('click', () => cambiarVista('mes'));
            increaseGoalBtn.addEventListener('click', () => ajustarMeta(1));
            decreaseGoalBtn.addEventListener('click', () => ajustarMeta(-1));

            // Carga inicial
            cambiarVista('semana');
        }

        // --- Lógica para la tarjeta de Métricas ---
        function inicializarMetricas(uid) {
            // Elementos de la tarjeta
            const metricsLoader = document.getElementById('metricsLoader');
            const metricsContent = document.getElementById('metricsContent');
            const metricsMonthEl = document.getElementById('metricsMonth');

            // Container donde inyectaremos filas dinámicas (si no existe, lo creamos)
            let dynamicContainer = document.getElementById('dynamicMetricsContainer');
            if (!dynamicContainer) {
                dynamicContainer = document.createElement('div');
                dynamicContainer.id = 'dynamicMetricsContainer';
                // Insertar al inicio del metricsContent para que las métricas del entrenador aparezcan arriba
                metricsContent.insertBefore(dynamicContainer, metricsContent.firstChild);
            }

            // Mantener referencia de métricas definidas por el entrenador
            let trainerMetrics = null;

            // Util: sanitizar clave para ids
            const keyToId = (k) => `metric_${k.replace(/[^a-zA-Z0-9]/g, '_')}`;

            // NUEVO: convertir keys tipo CamelCase o con números a etiquetas legibles
            function humanizeKey(key) {
                if (!key) return '';
                // Reemplaza underscores por espacios
                let s = key.replace(/_/g, ' ');
                // Inserta espacio entre lower->Upper (CamelCase)
                s = s.replace(/([a-z0-9])([A-Z])/g, '$1 $2');
                // Inserta espacio entre letra y número
                s = s.replace(/([a-zA-Z])([0-9])/g, '$1 $2');
                // Poner cada palabra capitalizada
                s = s.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                return s;
            }

            // Deducir unidad según clave (ampliada)
            const inferUnit = (key) => {
                const k = (key || '').toLowerCase();
                if (k.includes('peso') || k.includes('kg') || k.includes('mass') || k.includes('masa')) return 'kg';
                if (k.includes('grasa') || k.includes('%')) return '%';
                if (k.includes('musculo') || k.includes('músculo') || k.includes('muscle')) return 'kg';
                // Fuerza / rendimiento
                if (k.includes('press') || k.includes('banca') || k.includes('sentad') || k.includes('sentadilla') || k.includes('rm')) return 'kg';
                // Tiempo (mostrar tal cual si viene como "mm:ss")
                if (k.includes('tiempo') || k.includes('5km') || k.match(/\bmin\b/)) return ''; // sin unidad visible
                if (k.includes('imc')) return '';
                // default vacío
                return '';
            };

            // Crear fila de métrica si no existe (nombre visible = label)
            function ensureMetricRow(key, label) {
                const baseId = keyToId(key);
                if (document.getElementById(baseId)) return; // ya existe

                const unidad = inferUnit(key);
                const humanLabel = humanizeKey(label || key);
                const row = document.createElement('div');
                row.className = 'metric-row mb-3';
                row.id = baseId;

                row.innerHTML = `
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">${humanLabel} <small class="text-xs text-indigo-600 ml-2 trainer-badge hidden"></small></span>
                        <span id="${baseId}_valor" class="font-medium">-- ${unidad}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                        <div id="${baseId}_barra" class="bg-indigo-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                `;
                // Añadimos al contenedor dinámico (arriba)
                dynamicContainer.appendChild(row);
            }

            // Actualizar fila con datos (SIN comparación)
            function updateMetricRow(key, valorActual, valorAnterior, unidad, marcadoEntrenador) {
                const baseId = keyToId(key);
                const valorEl = document.getElementById(`${baseId}_valor`);
                const barraEl = document.getElementById(`${baseId}_barra`);
                const badge = document.querySelector(`#${baseId} .trainer-badge`);

                // Mostrar valor: si es string con ":" (tiempo) mostrar tal cual sin unidad
                const isTimeString = (v) => (typeof v === 'string' && v.indexOf(':') !== -1);

                if (valorEl) {
                    if (valorActual !== null && valorActual !== undefined) {
                        if (isTimeString(valorActual) || unidad === '') {
                            valorEl.textContent = `${valorActual}`; // mostrar tal cual
                        } else {
                            valorEl.textContent = `${valorActual} ${unidad}`;
                        }
                    } else {
                        valorEl.textContent = `-- ${unidad}`;
                    }
                }

                if (barraEl) {
                    // heurística simple para porcentaje visual: normalizar según tipo
                    let percent = 0;
                    if (unidad === 'kg') {
                        const num = parseFloat(valorActual) || 0;
                        percent = Math.min(100, (num / 1.5));
                    } else if (unidad === '%') {
                        percent = Math.min(100, (parseFloat(valorActual) || 0) * 2);
                    } else {
                        percent = isTimeString(valorActual) ? 50 : Math.min(100, (parseFloat(valorActual) || 0));
                    }
                    barraEl.style.width = `${percent}%`;
                }

                if (badge) {
                    if (marcadoEntrenador) badge.classList.remove('hidden');
                    else badge.classList.add('hidden');
                }
            }

            // Suscripción en tiempo real al documento con métricas definidas por el entrenador
            const trainerDocRef = doc(db, 'metricas', uid);
            const unsubscribeTrainer = onSnapshot(trainerDocRef, (snap) => {
                metricsLoader.style.display = 'none';
                metricsContent.classList.remove('hidden');
                // elementos de la nueva card
                const weightEl = document.getElementById('weightValue');
                const heightEl = document.getElementById('heightValue');
                const bmiEl = document.getElementById('bmiValue');

                if (snap.exists()) {
                    trainerMetrics = snap.data();

                    // Helper: decide si clave debe ignorarse (fechas / peso / altura / imc)
                    const ignoreKey = (k) => /(fecha|ultima|last|timestamp|^peso$|^altura$|^imc$)/i.test(k);

                    // Procesar entradas: admitir valores primitivos y objetos anidados (una capa)
                    Object.keys(trainerMetrics).forEach(key => {
                        if (ignoreKey(key)) return;

                        const value = trainerMetrics[key];
                        if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
                            // iterar subclaves (ej: fuerza: { PressBanca: 80, Sentadilla: 100 })
                            Object.keys(value).forEach(subKey => {
                                if (ignoreKey(subKey)) return;
                                const composedKey = `${key}_${subKey}`; // id único
                                const composedLabel = `${subKey}`; // el humanizeKey lo convertirá
                                ensureMetricRow(composedKey, composedLabel);
                            });
                        } else {
                            // valor primitivo directo
                            ensureMetricRow(key, key);
                        }
                    });

                    // Actualizar valores: misma lógica (soporta objetos anidados)
                    Object.keys(trainerMetrics).forEach(key => {
                        if (ignoreKey(key)) return;

                        const value = trainerMetrics[key];
                        if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
                            Object.keys(value).forEach(subKey => {
                                if (ignoreKey(subKey)) return;
                                const composedKey = `${key}_${subKey}`;
                                const unidad = inferUnit(subKey);
                                updateMetricRow(composedKey, value[subKey], null, unidad, true);
                            });
                        } else {
                            const unidad = inferUnit(key);
                            updateMetricRow(key, value, null, unidad, true);
                        }
                    });

                    // Rellenar la nueva card con peso/altura/imc si están definidos por el entrenador
                    const peso = (trainerMetrics.peso !== undefined && trainerMetrics.peso !== null) ? trainerMetrics.peso : null;
                    const altura = (trainerMetrics.altura !== undefined && trainerMetrics.altura !== null) ? trainerMetrics.altura : null;

                    if (weightEl) weightEl.textContent = peso !== null ? `${peso} kg` : '-- kg';
                    if (heightEl) heightEl.textContent = altura !== null ? `${altura} cm` : '-- cm';

                    if (bmiEl) {
                        if (peso !== null && altura !== null && altura > 0) {
                            const bmi = (peso / Math.pow(altura / 100, 2));
                            bmiEl.textContent = isFinite(bmi) ? bmi.toFixed(1) : '--';
                        } else {
                            bmiEl.textContent = '--';
                        }
                    }

                    metricsMonthEl.textContent = "Definido por entrenador";
                } else {
                    // no hay métricas del entrenador
                    metricsMonthEl.textContent = "Sin datos";
                    if (weightEl) weightEl.textContent = '-- kg';
                    if (heightEl) heightEl.textContent = '-- cm';
                    if (bmiEl) bmiEl.textContent = '--';
                }
            }, (err) => {
                console.error('Error suscribiéndose a métricas del entrenador:', err);
                metricsLoader.innerHTML = '<span class="text-red-500">Error al cargar</span>';
            });
        }
    </script>
</body>
</html>